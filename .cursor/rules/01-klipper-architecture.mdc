# Klipper Architecture - How The System Actually Works

## KLIPPER IS NOT MARLIN - Key Differences

### Architecture Overview
```
+---------------------------------------------+
|  Host (Raspberry Pi / SBC - Python)         |
|  - klippy.py (main process)                 |
|  - Parses G-code                            |
|  - Plans motion                             |
|  - Manages configuration                    |
|  - Communicates via serial/USB              |
+---------------------+-----------------------+
                      | Serial Protocol
                      | (binary, not G-code)
+---------------------v-----------------------+
|  MCU (3D Printer Board - C)                 |
|  - Executes step commands                   |
|  - Handles timing-critical operations       |
|  - Reads sensors                            |
|  - Controls heaters, fans, steppers         |
+---------------------------------------------+
```

### NEVER Assume Marlin Conventions
- Klipper does NOT run G-code on MCU
- Klipper does NOT use `#define` in configs
- Klipper does NOT support all Marlin G-codes
- Klipper uses `.cfg` files (INI-like format)
- Klipper extends G-code via Python modules
- Klipper timing happens on host, not MCU

## CONFIGURATION FILE STRUCTURE

### Syntax Rules (CRITICAL - VERIFY BEFORE USE)

```ini
# CORRECT: Uses colons, not equals
[section_name]
parameter: value
another_parameter: value with spaces
numeric_value: 123.45

# WRONG: Uses equals (this is NOT INI format)
[section_name]
parameter = value  # THIS WILL FAIL

# CORRECT: Pin definitions
pin: ^PA4          # Pullup enabled
pin: !PB5          # Inverted
pin: ^!PC6         # Pullup + inverted

# WRONG: Invalid pin syntax
pin: PA4_PULLUP    # NO - use ^ for pullup
pin: ~PB5          # NO - use ! for inversion

# CORRECT: Comments
# This is a comment
parameter: value  # Inline comment

# CORRECT: Multi-line values (indented)
gcode:
    G1 X10 Y10 F3000
    M117 Moving to position
    G4 P1000
```

### Config Section Types

**Hardware Sections:**
```ini
[stepper_x]        # Stepper motor configuration
[extruder]         # Extruder and hotend
[heater_bed]       # Heated bed
[fan]              # Part cooling fan
[temperature_sensor name]  # Temperature monitoring
[filament_switch_sensor name]  # Filament runout
```

**Software Sections:**
```ini
[gcode_macro NAME]      # Custom G-code commands
[save_variables]        # Persistent storage
[virtual_sdcard]        # SD card emulation
[pause_resume]          # Pause/resume support
[display_status]        # Display information
```

**ALWAYS verify section names** at: https://www.klipper3d.org/Config_Reference.html

## MACRO SYSTEM (G-code Extensions)

### Macro Basics
```ini
# CORRECT: Macro definition
[gcode_macro PRINT_START]
description: Prepare printer for printing
gcode:
    G28                    # Home all axes
    G1 Z15.0 F6000        # Raise Z
    M117 Starting print   # Display message

# CORRECT: Macro with parameters
[gcode_macro LOAD_FILAMENT]
gcode:
    {% set speed = params.SPEED|default(300)|float %}
    G1 E50 F{speed}

# WRONG: Trying to use Python in gcode section
[gcode_macro BAD_MACRO]
gcode:
    import time  # NO - this is Jinja2, not Python
    time.sleep(1)  # NO - use G4 instead
```

### Jinja2 Template Engine
Klipper macros use **Jinja2**, not Python:

```ini
# CORRECT: Jinja2 syntax
{% set bed_temp = params.BED|default(60)|float %}
{% if printer.toolhead.homed_axes != "xyz" %}
    G28  # Home if not already homed
{% endif %}

# WRONG: Python syntax in macros
if not printer.toolhead.homed_axes == "xyz":  # NO
    G28
```

### Accessing Printer State
```ini
# Available printer state variables:
printer.toolhead.position.x       # Current X position
printer.extruder.temperature      # Current hotend temp
printer.extruder.target          # Target hotend temp
printer.heater_bed.temperature   # Bed temp
printer.fan.speed                # Part cooling fan (0.0-1.0)
printer["filament_switch_sensor e0_sensor"].enabled
```

**ALWAYS verify** available objects in Status Reference docs

## PYTHON MODULES (Extending Klipper)

### Module Structure
```python
# CORRECT: Klipper module pattern
class FilamentSensorHelper:
    def __init__(self, config):
        self.printer = config.get_printer()
        self.name = config.get_name().split()[-1]
        self.gcode = self.printer.lookup_object('gcode')

        # Register commands
        self.gcode.register_command(
            'CHECK_FILAMENT',
            self.cmd_CHECK_FILAMENT,
            desc="Check filament sensor status"
        )

    def cmd_CHECK_FILAMENT(self, gcmd):
        # Command implementation
        gcmd.respond_info("Filament sensor: OK")

def load_config(config):
    return FilamentSensorHelper(config)
```

### NEVER Create Redundant Modules
Before writing a Python module:
1. Check if functionality exists in core Klipper
2. Check extras/ directory for similar modules
3. Search existing codebase for related code
4. Don't duplicate `filament_switch_sensor` functionality
5. Don't reimplement standard macros

## COMMON KLIPPER OBJECTS

### Must Know These:
- `klippy/` - Main host code
- `klippy/extras/` - Optional modules (sensors, displays, etc.)
- `config/` - Example configurations
- `scripts/` - Utility scripts
- `src/` - MCU firmware code (C)

### Important Python Files:
- `klippy/gcode.py` - G-code parser
- `klippy/toolhead.py` - Motion planning
- `klippy/mcu.py` - MCU communication
- `klippy/heater.py` - Temperature control

## FILE ORGANIZATION (gschpoozi)

### Proposed Structure:
```
gschpoozi/
├── macros/              # Standalone macro files
│   ├── print_start.cfg
│   ├── print_end.cfg
│   ├── homing.cfg
│   └── filament.cfg
├── hardware/            # Hardware abstraction
│   ├── steppers/
│   ├── extruders/
│   └── sensors/
├── profiles/            # Printer-specific profiles
│   ├── voron/
│   ├── ender/
│   └── custom/
└── scripts/             # Validation and utilities
```

### Include Pattern:
```ini
# CORRECT: Include order matters
[include gschpoozi/macros/print_start.cfg]
[include gschpoozi/macros/homing.cfg]

# Printer-specific configs come AFTER includes
[stepper_x]
position_max: 300  # Override for your printer
```

## VERIFICATION CHECKLIST

Before suggesting ANY Klipper code:

- [ ] Is the syntax using `:` not `=`?
- [ ] Have I verified section names in Config_Reference?
- [ ] Are pin definitions using correct syntax (`^`, `!`)?
- [ ] If using macros, is it Jinja2 (not Python)?
- [ ] Does similar functionality already exist?
- [ ] Have I checked for existing includes?
- [ ] Will this work with the serial protocol model?

## REFERENCES (ALWAYS CHECK THESE)

- **Config Reference**: https://www.klipper3d.org/Config_Reference.html
- **G-Code Commands**: https://www.klipper3d.org/G-Codes.html
- **Status Reference**: https://www.klipper3d.org/Status_Reference.html
- **Command Templates**: https://www.klipper3d.org/Command_Templates.html

## ANTI-HALLUCINATION: DON'T INVENT

### NEVER Invent:
- Config section names (e.g., `[filament_sensor]` doesn't exist)
- Parameter names (e.g., `runout_command:` doesn't exist, use `runout_gcode:`)
- G-code commands (verify all commands in docs)
- Pin names (must match MCU pinout)
- Printer state variables (check Status_Reference)

### ALWAYS Verify:
- Look up section in Config_Reference
- Check existing code for similar patterns
- Test on development printer first
- Ask user to confirm pin assignments
